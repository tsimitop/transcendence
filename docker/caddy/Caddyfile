{
	debug
}

localhost {
	# TLS configuration for self-signed certificates
	tls internal

	# Handle OPTIONS preflight requests globally
	@options {
		method OPTIONS
	}
	handle @options {
		header {
			Access-Control-Allow-Origin "*"
			Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
			Access-Control-Allow-Credentials "true"
			Vary "Origin"
		}
		respond "" 204
	}

	# Handle the backend API - using plain HTTP internally
	handle_path /api/* {
		header {
			Access-Control-Allow-Origin "*"
			Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
			Access-Control-Allow-Credentials "true"
			Vary "Origin"
		}
		reverse_proxy http://backend:3000 {
			header_up Host {host}
			header_up X-Real-IP {remote}
			header_up X-Forwarded-For {remote}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Handle the frontend (static files)
	handle {
		root * /srv
		try_files {path} {path}/ /index.html
		file_server
	}

	# Error page for 5xx errors
	handle_errors {
		@5xx expression `{err.status_code} >= 500 && {err.status_code} < 600`
		handle @5xx {
			root * /srv
			rewrite * /50x.html
			file_server
		}
	}
}