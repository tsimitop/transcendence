{
	debug
}

localhost {
	# TLS configuration for self-signed certificates
	tls internal

	# Global CORS headers - these apply to all API responses
	@api {
		path /api/*
	}
	handle @api {
		header {
			# Allow CORS from both the dev server and the static frontend
			Access-Control-Allow-Origin {http.request.header.Origin}
			Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
			Access-Control-Allow-Credentials "true"
			Vary "Origin"
		}
		
		# Handle preflight requests
		@options {
			method OPTIONS
		}
		handle @options {
			respond "" 204
		}

		# Forward all other requests to the backend
		reverse_proxy http://backend:3000 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}	

	# Handle the frontend (static files)
	handle {
		root * /srv
		try_files {path} {path}/ /index.html
		file_server
	}

	# Error page for 5xx errors
	handle_errors {
		@5xx expression `{err.status_code} >= 500 && {err.status_code} < 600`
		handle @5xx {
			root * /srv
			rewrite * /50x.html
			file_server
		}
	}
}